name: Deploy Gate

on:
  pull_request:
    branches: [main]

jobs:
  permission-check:
    name: Permission Protocol
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for protected paths
        id: check
        run: |
          # Protected paths require PP approval
          PROTECTED_REGEX='^(deploy/|\.github/workflows/)'
          
          CHANGED=$(gh pr view ${{ github.event.pull_request.number }} \
            --json files --jq '.files[].path')
          
          echo "ğŸ“ Changed files:"
          echo "$CHANGED"
          echo ""
          
          HITS=$(echo "$CHANGED" | grep -E "$PROTECTED_REGEX" || true)
          if [ -n "$HITS" ]; then
            echo "ğŸ”’ Protected files changed:"
            echo "$HITS"
            echo "protected=true" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… No protected files"
            echo "protected=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Verify PP Receipt
        if: steps.check.outputs.protected == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” PERMISSION PROTOCOL - Deploy Authorization Required"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          REPO="${{ github.repository }}"
          REPO="${REPO,,}"
          SHA="${{ github.event.pull_request.head.sha }}"
          PR="${{ github.event.pull_request.number }}"
          
          RESPONSE=$(curl -s -X POST \
            "${{ secrets.PP_BASE_URL }}/api/v1/receipts/verify" \
            -H "X-PP-API-Key: ${{ secrets.PP_API_KEY }}" \
            -H "X-PP-Request-Create-Token: ${{ secrets.PP_REQUEST_CREATE_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"scope\": {
                \"repo\": \"${REPO}\",
                \"prNumber\": ${PR},
                \"headSha\": \"${SHA}\",
                \"env\": \"production\",
                \"capability\": \"deploy:production\"
              },
              \"redeem\": false,
              \"failOnMissing\": true
            }")
          
          VALID=$(echo "$RESPONSE" | jq -r '.valid // false')
          REQUEST_ID=$(echo "$RESPONSE" | jq -r '.requestId // empty')
          APPROVAL_URL=$(echo "$RESPONSE" | jq -r '.approvalUrl // empty')
          
          if [ "$VALID" = "true" ]; then
            echo "âœ… APPROVED - Receipt verified"
            echo ""
            echo "This deployment has been authorized by a human."
            echo "Merge allowed."
          else
            echo "âŒ NO RECEIPT - Approval required"
            echo ""
            echo "This PR changes protected deployment files."
            echo "A human must approve before merge."
            echo ""
            if [ -n "$APPROVAL_URL" ]; then
              echo "ğŸ‘‰ APPROVE HERE: $APPROVAL_URL"
            else
              echo "ğŸ‘‰ Go to: ${{ secrets.PP_BASE_URL }}/pp/deploy-requests"
            fi
            echo ""
            echo "After approval, re-run this workflow."
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
      
      - name: Skip (Unprotected)
        if: steps.check.outputs.protected != 'true'
        run: echo "âœ… No protected paths changed - merge allowed"
